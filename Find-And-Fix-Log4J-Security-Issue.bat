@echo off
:: *******************************************************************
:: Find and Fix Log4J Security Issue : Windows Style
:: *******************************************************************
::
:: Name:
::   Find-And-Fix-Log4J-Security-Issue.bat
::
:: Description:
::   Script scan all the local drive, find the log4j impacted jars
:: and fix all the impacted jars
::  
:: Usage:
::   APPLY_FIX= FALSE create only report in the log director, TRUE will also fix the result jars
::   LOG4J_LOG_DIR= Make sure the log directory exist and all users having write access on this folder
::
:: Change History:
::   Date         |    Who    | Description
::   =============|===========|=======================================
::   16 Dec 2021  | Chandru G | Initial
::   21 Dec 2021  | Chandru G | Skip Size 0, additional class removal for v1.x
::
:: *******************************************************************

SET ZIP_PATH=C:\PROGRA~1\7-Zip\7z.exe
set RESULT_FILE_NAME=log4j_impacted_jars
set APPLY_FIX=FALSE
set LOG4J_LOG_DIR=%temp%

TITLE Find and Fix the Log4j Issue

IF NOT EXIST %ZIP_PATH% (
@echo ------------------------------------------------------------------------------------
@echo 7Zip is not installed : %ZIP_PATH%, So using UnZip
@echo ------------------------------------------------------------------------------------
pause
exit 1
)

REM ------------------------------------------------------------------------------------
REM Block for applying timestamp for the log
REM ------------------------------------------------------------------------------------
for /f "delims=" %%A in ('powershell -c "get-date -format yyyy-MM-dd-HH-mm-ss"') do @set LOGTIMESTAMP=%%A
for /f "delims=" %%A in ('cmd /c hostname') do @set HOST_NAME=%%A

set RESULT_FILE_NAME=%HOST_NAME%_%RESULT_FILE_NAME%_%LOGTIMESTAMP%.txt
REM ------------------------------------------------------------------------------------
REM Check whether the log directory having write access
REM ------------------------------------------------------------------------------------
copy /Y NUL "%LOG4J_LOG_DIR%\.writable" > NUL 2>&1 && set WRITEOK=1
IF NOT DEFINED WRITEOK set LOG4J_LOG_DIR=%TEMP%
IF DEFINED WRITEOK DEL /Q /F "%LOG4J_LOG_DIR%\.writable"
IF NOT EXIST "%LOG4J_LOG_DIR%\." set LOG4J_LOG_DIR=C:\Temp
IF NOT EXIST "%LOG4J_LOG_DIR%\." set LOG4J_LOG_DIR=C:\Windows\Temp
set RESULT_FILE=%LOG4J_LOG_DIR%\%RESULT_FILE_NAME%

@echo ------------------------------------------------------------------------------------
@echo Deleting the Result file if exist : %RESULT_FILE%
@echo ------------------------------------------------------------------------------------
IF EXIST "%RESULT_FILE%" DEL /Q /F "%RESULT_FILE%"
IF EXIST "%RESULT_FILE%.error" DEL /Q /F "%RESULT_FILE%.error"
@echo.

@echo ------------------------------------------------------------------------------------
@echo Writing the name of impacted jars to file %RESULT_FILE%

SET GET_DRIVE=wmic logicaldisk where "drivetype=3" get caption

FOR /f "tokens=1,2 delims=: " %%a in ('%GET_DRIVE%') DO (
    IF "%%a." neq "Caption." IF "%%a." neq "." (
        @echo.
        @echo *** Processing the Drive %%a:\
        REM Process all the Jars to check the JndiLookup.class SocketServer.class SMTPAppender.class JMSAppender.class SMTPAppender$1.class
        for /f "delims=" %%E in ('FORFILES /P %%a:\ /S /M *.jar /C "cmd /min /c set __COMPAT_LAYER=RunAsAdmin && if not @fsize EQU 0 echo @path"') do (
            %ZIP_PATH% l %%E | FINDSTR /i /C:"\JndiLookup.class" /C:"\JMSAppender.class" /C:"\SocketServer.class" /C:"\SMTPAppender.class" /C:"\SMTPAppender$1.class" && echo %%E >> %RESULT_FILE%
        )
    )
)

REM ------------------------------------------------------------------------------------
REM Block for applying the fix
REM ------------------------------------------------------------------------------------
IF "%APPLY_FIX%."=="TRUE." (
    @echo.
    @echo ------------------------------------------------------------------------------------
    @echo Applying the fix : Remove JndiLookup.class and other related class
    @echo ------------------------------------------------------------------------------------
    IF EXIST "%RESULT_FILE%" (
        FOR /F "tokens=* delims=" %%a in ('Type "%RESULT_FILE%"') DO (
            @echo Fixing file : %%a
            FOR /f "tokens=1,2 delims= " %%x in ('attrib %%a') DO (
                IF "%%y."=="R." (
                    attrib -R %%a
                    %ZIP_PATH% d %%a JndiLookup.class SocketServer.class SMTPAppender.class JMSAppender.class SMTPAppender$1.class -r
                    if errorlevel 1 echo ERROR : %%a >> %RESULT_FILE%.error
                    attrib +R %%a
                ) ELSE (
                    %ZIP_PATH% d %%a JndiLookup.class SocketServer.class SMTPAppender.class JMSAppender.class SMTPAppender$1.class -r
                    if errorlevel 1 echo ERROR : %%a >> %RESULT_FILE%.error
                )                
            )
        )
    ) ELSE (
        @echo *** No Jars found to apply fix ***
        @echo *** No Jars found to apply fix *** >> %RESULT_FILE%
    )
) ELSE (
    IF NOT EXIST "%RESULT_FILE%" (
        @echo *** No Impacted Jars found ***
        @echo *** No Impacted Jars found *** >> %RESULT_FILE%
    )
)

@echo.
@echo ------------------------------------------------------------------------------------
@echo Please check the file %RESULT_FILE% for the impacted data
@echo Please check the file %RESULT_FILE%.error for unprocessed data
@echo ------------------------------------------------------------------------------------

pause
exit 0
