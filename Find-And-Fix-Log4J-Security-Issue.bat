@echo off
:: *******************************************************************
:: Find and Fix Log4J Security Issue : Windows Style
:: *******************************************************************
::
:: Name:
::   Find-And-Fix-Log4J-Security-Issue.bat
::
:: Description:
::   Script scan all the local drive, find the log4j impacted jars
:: and fix all the impacted jars
::
::
:: Change History:
::   Date         |    Who    | Description
::   =============|===========|=======================================
::   16 Dec 2021  | Chandru G | Initial
::
:: *******************************************************************

SET ZIP_PATH=C:\PROGRA~1\7-Zip\7z.exe
set RESULT_FILE=%TEMP%\log4j_impacted_jars_details.txt
set APPLY_FIX=TRUE

TITLE Find and Fix the Log4j Issue

IF NOT EXIST %ZIP_PATH% (
@echo ------------------------------------------------------------------------------------
@echo 7Zip is not installed : %ZIP_PATH%, So using UnZip
@echo ------------------------------------------------------------------------------------
pause
exit 1
)

IF NOT DEFINED TEMP set RESULT_FILE=C:\Temp\log4j_impacted_jars_details.txt
IF NOT EXIST "C:\Temp\." set RESULT_FILE=C:\Windows\Temp\log4j_impacted_jars_details.txt

@echo ------------------------------------------------------------------------------------
@echo Deleting the Result file if exist : %RESULT_FILE%
@echo ------------------------------------------------------------------------------------
IF EXIST "%RESULT_FILE%" DEL /Q /F "%RESULT_FILE%"
IF EXIST "%RESULT_FILE%.error" DEL /Q /F "%RESULT_FILE%.errror"
@echo.

@echo ------------------------------------------------------------------------------------
@echo Writing the name of impacted jars to file %RESULT_FILE%

SET GET_DRIVE=wmic logicaldisk where "drivetype=3" get caption

FOR /f "tokens=1,2 delims=: " %%a in ('%GET_DRIVE%') DO (
    IF "%%a." neq "Caption." IF "%%a." neq "." (
        @echo.
        @echo *** Processing the Drive %%a:\
        REM Process all the Jars to check the JndiLookup.class
        FORFILES /P %%a:\ /S /M *.jar /C "cmd /min /c set __COMPAT_LAYER=RunAsAdmin && %ZIP_PATH% l @file | FINDSTR /i /C:"\JndiLookup.class" && echo @path >> %RESULT_FILE%"
    )
)

REM *********************** Verify the fix in local development ***********************
REM cd /d D:\Temp\TC12R210
REM FORFILES /S /M *.jar /C "cmd /c %ZIP_PATH% l @file | FINDSTR /i /C:"\JndiLookup.class" && echo @path >> %RESULT_FILE%"
REM *********************** Verify the fix in local development ***********************

IF "%APPLY_FIX%."=="TRUE." (
    @echo.
    @echo ------------------------------------------------------------------------------------
    @echo Applying the fix : Remove JndiLookup.class
    @echo ------------------------------------------------------------------------------------
    IF EXIST "%RESULT_FILE%" (
        FOR /F "tokens=* delims=" %%a in ('Type "%RESULT_FILE%"') DO (
            @echo Fixing file : %%a
            FOR /f "tokens=1,2 delims= " %%x in ('attrib %%a') DO (
                IF "%%y."=="R." (
                    attrib -R %%a
                    %ZIP_PATH% d %%a JndiLookup.class -r
                    attrib +R %%a
                ) ELSE (
                    %ZIP_PATH% d %%a JndiLookup.class -r
                )
                if not errorlevel 0 echo %errorlevel% : %%a >> %RESULT_FILE%.error"
            )
        )
    ) ELSE ( @echo *** No Jars found to apply fix *** )
)

@echo.
@echo ------------------------------------------------------------------------------------
@echo Please check the file %RESULT_FILE% for the processed data
@echo Please check the file %RESULT_FILE%.error for unprocessed data
@echo ------------------------------------------------------------------------------------

pause
exit 0